<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Manifest Merger</title>
<link rel="icon" type="image/png"

        href="https://assets.dpdhl-brands.com/guides/dhl/guides/design-basics/logo-and-claim/logo/versions-03.png">
<!-- PDF.js & PDF-Lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<!-- Sortable.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<!-- Vanta + Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
<style>

    body {

      font-family: Arial,sans-serif;

      background: #f7f9fc;

      display: flex;

      flex-direction: column;

      align-items: center;

      padding: 2rem;

    }
	
	 #logo-placeholder {

      width: 369px;

      height: 150px;

      margin-bottom: 20px;

      display: flex;

      align-items: center;

      justify-content: center;

      color: #555;

      border-radius: 5px;

    }

    h1 { margin-bottom: 1rem; }

    #drop-area {

      width: 80%; max-width: 600px;

      height: 150px;

      border: 2px dashed #999;

      border-radius: 10px;

      background: #fff;

      display: flex;

      flex-direction: column;

      align-items: center;

      justify-content: center;

      margin-bottom: 1rem;

      transition: border-color 0.2s;

    }

    #drop-area.dragover { border-color: #FFCC00; }

    #file-list {

      width: 80%; max-width: 600px;

      background: #fff;

      border-radius: 10px;

      overflow: hidden;

      margin-bottom: 1rem;

    }

    .file-item {

      display: flex;

      justify-content: space-between;

      align-items: center;

      padding: 0.5rem 1rem;

      border-bottom: 1px solid #eee;

      cursor: grab;

      position: relative;

    }

    .file-item:last-child { border-bottom: none; }

    .file-item::before {

      content: '≡';

      font-size: 1.2rem;

      color: #ccc;

      margin-right: 0.5rem;

      cursor: grab;

    }

    .file-name {

      flex: 1;

      font-weight: bold;

      color: #333;

      user-select: none;

    }

    .file-actions button {

      margin-left: 0.5rem;

      padding: 0.3rem 0.6rem;

      border: none;

      border-radius: 4px;

      cursor: pointer;

      background: #FFCC00;

      color: black;

      font-size: 0.9rem;

    }

    .file-actions button.remove { background: #D40511; color: white; }

    #outputFilename {

      width: 80%; max-width: 600px;

      padding: 0.5rem;

      border: 1px solid #ccc;

      border-radius: 5px;

      margin-bottom: 1rem;

      font-size: 1rem;

    }

    #controls {

      display: flex;

      gap: 1rem;

      margin-bottom: 2rem;

    }

    #controls button {

      padding: 0.6rem 1.2rem;

      border: none;

      border-radius: 5px;

      cursor: pointer;

      font-size: 1rem;

    }
	#app-content {
	
	  display: flex;
	  
	  flex-direction: column;
	  
	  align-items: center;
	  
	  justify-content: center;
	}

    #merge-btn { background: #FFCC00; color: black; }

    #remove-all-btn { background: #D40511; color: #fff; }

    .sortable-ghost { opacity: 0.3 !important; }

    .sortable-chosen { background: #e9ecef !important; }
</style>
</head>
<body>
<div id="vanta-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></div>
<div id="app-content" style="text-align: center; z-index: 1;">
<div id="logo-placeholder">
<a href="https://asml.sharepoint.com/sites/GMF-MS-LO-DHL-Shipping-5L-Group" target="_blank">
<img src="https://cdn.worldvectorlogo.com/logos/dhl-3.svg"

           alt="DHL Logo"

           style="max-width:100%; max-height:100%; object-fit:contain;">
</a>
</div>
<h1>Manifest Merger</h1>
<div id="drop-area">
<p>Drag & drop PDF files here</p>
<button onclick="fileInput.click()">Select PDFs</button>
<input type="file" id="fileInput" accept="application/pdf" multiple style="display:none">
</div>
<div id="file-list"></div>
<input type="text" id="outputFilename" placeholder="Enter merged file name" value="Merged_Manifest">
<div id="controls">
<button id="merge-btn">Generate Manifest PDF</button>
<button id="remove-all-btn">Remove All</button>
</div>
</div>
<script>

    const dropArea = document.getElementById('drop-area');

    const fileInput = document.getElementById('fileInput');

    const fileList = document.getElementById('file-list');

    const mergeBtn = document.getElementById('merge-btn');

    const removeAllBtn = document.getElementById('remove-all-btn');

    const outputFilename = document.getElementById('outputFilename');

    let pdfFiles = [];

    // DRAG & DROP

    dropArea.addEventListener('dragover', e => {

      e.preventDefault();

      dropArea.classList.add('dragover');

    });

    dropArea.addEventListener('dragleave', () => {

      dropArea.classList.remove('dragover');

    });

    dropArea.addEventListener('drop', e => {

      e.preventDefault();

      dropArea.classList.remove('dragover');

      handleFiles(e.dataTransfer.files);

    });

    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    function handleFiles(files) {

      for (let f of files) {

        if (f.type === 'application/pdf') pdfFiles.push(f);

      }

      renderFileList();

    }

    function renderFileList() {

      fileList.innerHTML = '';

      pdfFiles.forEach((file, idx) => {

        const name = file.name.replace(/\.pdf$/i,'');

        const div = document.createElement('div');

        div.className = 'file-item';

        div.dataset.index = idx;

        div.innerHTML = `
<span class="file-name">${name}</span>
<span class="file-actions">
<button onclick="previewPDF(${idx})">Preview</button>
<button class="remove" onclick="removePDF(${idx})">Remove</button>
</span>

        `;

        fileList.appendChild(div);

      });

      Sortable.create(fileList, {

        animation: 150,

        ghostClass: 'sortable-ghost',

        chosenClass: 'sortable-chosen',

        onEnd: evt => {

          const [moved] = pdfFiles.splice(evt.oldIndex,1);

          pdfFiles.splice(evt.newIndex,0,moved);

          renderFileList();

        }

      });

    }

    function previewPDF(i) {

      window.open(URL.createObjectURL(pdfFiles[i]), '_blank');

    }

    function removePDF(i) {

      pdfFiles.splice(i,1);

      renderFileList();

    }

    removeAllBtn.addEventListener('click', () => {

      pdfFiles = [];

      renderFileList();

    });

    mergeBtn.addEventListener('click', async () => {

      if (!pdfFiles.length) return alert('Please select PDF files first.');

      // push files into the hidden fileInput so generatePDF() picks them up

      const dt = new DataTransfer();

      pdfFiles.forEach(f => dt.items.add(f));

      fileInput.files = dt.files;

      // set the desired output name

      document.getElementById('generateBtn')?.remove(); // if using original button

      // override filename if your generatePDF reads another input, else:

      // directly name your download inside generatePDF to outputFilename.value + '.pdf'

      // finally call your existing generatePDF()

      await generatePDF();

    });
 const LEFT = 30,

          PAGE_W = 842,

          PAGE_H = 595,

          ROW_H = 12,

          HEADER_H = ROW_H * 2.2,

          GAP_AFTER_TOTAL = 14;

    const COL_HEADERS = [

      ["Load no.",""], ["Loadingplace",""], ["Order number","Reference no."],

      ["Delivery ID","HU-ID"], ["HU-Description",""], ["Delivery","HU Remark"],

      ["Gross","kg/volume"], ["Country / ZIP / City","Planned QTY"],

      ["Actual","QTY"], ["Service",""]

    ];

    const COL_WIDTHS = [50,60,80,70,90,130,70,110,45,75];

    const TABLE_W = COL_WIDTHS.reduce((a,b)=>a+b,0);

    // valid HU-ID codes for splitting

    const VALID_CODES = [

      'AIRP','ARD','A1','BLOCKPALLET','BOX','B1','B2','CUSTOM','C1','C2','DGD','DUCT',

      'D1','D2','E','ENVELOPE','EUROPALLET','EXL','F1','F2','G2','ITC1','ITC2','ITC3','ITC4',

      'KH','KL','LH','LL','PARCEL','RETURN','RGX','RKN','RZA','RZX','RZY','TRIWALLBOX','VAQT',

      'YSPASRETM','1PACK','10','15','2PACK','20','20FTCONTAINER','3PACK','30','30FTCONTAINER',

      '35','4GVX20','4GVX24','4GVX27','4GVX55','4GVX7','4GV2','4GV20','4GV24','4GV55','4GV7',

      '40FTCONTAINER','40FTHCCONTAINER','40FTREEFER','4062','423','4257','511','522/551','531',

      '532','541','55','5512','552','561','571','572','581','582','591','592','60','601','6012',

      '611','621','631','65','70','7030'

    ];

    let data, globalFont, globalFontB;

    function drawText(pg, txt, x, y, size=9, font=globalFont) {

      const sx = (typeof x==='number' && !isNaN(x)) ? x : LEFT;

      const sy = (typeof y==='number' && !isNaN(y)) ? y : ROW_H;

      pg.drawText(txt, { x: sx, y: sy, size, font });

    }

    function drawLine(pg, x1,y1,x2,y2) {

      pg.drawLine({ start:{x:x1,y:y1}, end:{x:x2,y:y2}, thickness:0.5 });

    }

    function fillRect(pg, x,y,w,h,color) {

      pg.drawRectangle({ x, y:y-h, width:w, height:h, color });

    }

    function formatDT(d) {

      const dd = String(d.getDate()).padStart(2,'0'),

            mm = String(d.getMonth()+1).padStart(2,'0'),

            yy = d.getFullYear(),

            hh = String(d.getHours()).padStart(2,'0'),

            mi = String(d.getMinutes()).padStart(2,'0');

      return `${dd}/${mm}/${yy} ${hh}:${mi}`;

    }

    function drawFooter(pg, pgNum, isLast, total) {

      drawText(pg, "Name and signature driver: ....................................................................", LEFT, ROW_H, 9);

      drawText(pg, `${pgNum}/${total}`, PAGE_W/2 - 10, ROW_H, 9);

      if (isLast) {

        drawText(pg, "Name and signature of loader, incl. stamp: ............................................", LEFT, ROW_H*2, 9);

        drawText(pg, "Loading remarks: ...................................................................................", LEFT, ROW_H*3, 9);

      }

    }

    /**

     * Draws and truncates text to fit within colWidth, trimming whitespace first.

     */

    function drawCellText(pg, txt, x, y, colWidth, size = 7, font = globalFont) {

      const maxW = colWidth - 4;

      const original = (txt || '').trim();

      let t = original;

      const ell = '…';

      while (t.length && font.widthOfTextAtSize(t + ell, size) > maxW) {

        t = t.slice(0, -1);

      }

      if (t.length < original.length) t += ell;

      drawText(pg, t, x, y, size, font);

    }

async function extractFromPDF(file) {

  const buf = await file.arrayBuffer();

  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

  let currentLoadingList = '';

  let currentService     = '';

  let prevArr            = null;

  for (let p = 1; p <= pdf.numPages; p++) {

    const page    = await pdf.getPage(p);

    const content = await page.getTextContent();

    const items   = content.items.map(it => ({

      str: it.str.trim(),

      x:   it.transform[4],

      y:   it.transform[5]

    }));

    const flat = items.map(i => i.str).join(' ');

    // ─ capture header info & totals ─

    const llm = flat.match(/\b(\d{8,})\b/);

    if (llm) currentLoadingList = llm[1];

    const pm = flat.match(/Logistics service provider:\s*(.*?)\s*Service:/);

    if (pm && !data.provider) data.provider = pm[1].trim();

    const sm = flat.match(/Service:\s*(.+?)(?=\s{2,}|$)/);

    if (sm) currentService = sm[1];

    data.service = data.service || currentService;

    data.orders  += +((flat.match(/Amount of orders:\s*(\d+)/)||[])[1]||0);

    data.weight  += [...flat.matchAll(/([\d,]+)\s*kg/g)]

                      .reduce((s,m)=>s + parseFloat(m[1].replace(',','.')),0);

    data.volume  += [...flat.matchAll(/([\d,]+)\s*m³/g)]

                      .reduce((s,m)=>s + parseFloat(m[1].replace(',','.')),0);

    data.huCount += (flat.match(/\b(1\d{8,}|200\d{7,})\b/g)||[]).length;

    // ─ group into rows by Y ─

    const lines = {};

    items.forEach(it => {

      const key = Math.round(it.y/5)*5;

      (lines[key] ||= []).push(it);

    });

    Object.keys(lines).sort((a,b)=>b-a).forEach(key => {

      const rowItems = lines[key].sort((a,b)=>a.x-b.x);

      // only real rows

      if (!rowItems.some(it=>it.str.startsWith('DN ')||/^\d{8,}$/.test(it.str))) return;

      // ─ build raw columns ─

      const arr = Array(COL_HEADERS.length).fill('');

      arr[0] = currentLoadingList;

      let xx = LEFT;

      for (let i = 1; i < COL_HEADERS.length; i++) {

        arr[i] = rowItems

          .filter(it=>it.x >= xx && it.x < xx + COL_WIDTHS[i])

          .map(it=>it.str.trim())

          .join(' ');

        xx += COL_WIDTHS[i];

      }

      // ─ split out code + suffix in col 3 & 4 ─

      const toks = arr[3].split(/\s+/);

      const idx  = toks.findIndex(t=> VALID_CODES.includes(t.toUpperCase()));

      if (idx !== -1) {

        arr[3] = toks[idx].toUpperCase();

        arr[4] = (toks.slice(idx+1).join(' ') + ' ' + arr[4]).trim();

      }

      // ─ NEW: orphan row—copy last HU-ID/Desc if those two are blank but there's data in col 5/6/7 ─

      if (!arr[3] && !arr[4] && (arr[5] || arr[6] || arr[7]) && prevArr) {

        arr[3] = prevArr[3];

        arr[4] = prevArr[4];

      }

      // ─ final trims ─

      arr[3] = arr[3].trim();

      arr[4] = arr[4].trim();

      // ─ service in last column ─

      arr[COL_HEADERS.length-1] = currentService;

      data.rows.push(arr);

      prevArr = arr;

    });

  }

}
 
 
 

/**

 * Draws text and, if it exceeds maxWidth, trims with “..” at the end.

 */

function drawEllipsizedText(pg, text, x, y, maxWidth, size = 9, font = globalFont) {

  const ell = "..";

  let str = text;

  if (font.widthOfTextAtSize(str, size) <= maxWidth) {

    pg.drawText(str, { x, y, size, font });

    return;

  }

  while (str.length && font.widthOfTextAtSize(str + ell, size) > maxWidth) {

    str = str.slice(0, -1);

  }

  pg.drawText(str + ell, { x, y, size, font });

}

/**

 * Draws text and, if it exceeds maxWidth, trims with “..” at the end.

 */
 
 /**

 * Collapse an array of service strings like

 * [ “FedEx Int. Priority”, “FedEx Int. Economy”, “FedEx Int. Emergency” ]

 * into a single string “FedEx Int. Priority/Economy/Emergency”.

 */

function collapseServices(services) {

  if (!services || !services.length) return '';

  // remove duplicates

  const arr = Array.from(new Set(services.map(s => s.trim()).filter(Boolean)));

  if (arr.length === 1) return arr[0];

  // take the first, split off at last space to get the root

  const first = arr[0];

  const idx   = first.lastIndexOf(' ');

  const root  = idx < 0 ? first : first.slice(0, idx);

  // for each string, strip off the root + space to get its “suffix”

  const suffixes = arr.map(s =>

    s.startsWith(root + ' ') ? s.slice(root.length + 1) : s

  );

  return `${root} ${suffixes.join('/')}`;

}
 

function drawEllipsizedText(pg, text, x, y, maxWidth, size = 9, font = globalFont) {

  const ell = "..";

  let str = text;

  if (font.widthOfTextAtSize(str, size) <= maxWidth) {

    pg.drawText(str, { x, y, size, font });

    return;

  }

  while (str.length && font.widthOfTextAtSize(str + ell, size) > maxWidth) {

    str = str.slice(0, -1);

  }

  pg.drawText(str + ell, { x, y, size, font });

}

async function generatePDF() {

  // ─── 1) Reset & re-extract ─────────────────────────────────────────────────

  data = {

    provider: '',

    service:  '',

    orders:   0,

    weight:   0,

    volume:   0,

    huCount:  0,

    rows:     []

  };

  const files = Array.from(document.getElementById('fileInput').files);

  if (!files.length) {

    alert('Select at least one PDF');

    return;

  }

  for (const f of files) {

    await extractFromPDF(f);

  }

  // ─── 2) Gather unique services from each row’s last column ───────────────────

  const svcSet = new Set(data.rows.map(r => r[9]).filter(Boolean));

  const svcArr = Array.from(svcSet);

  // ─── 3) Create PDF & embed fonts ────────────────────────────────────────────

  const pdfDoc    = await PDFLib.PDFDocument.create();

  globalFont      = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

  globalFontB     = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

  const pages     = [];

  let   page      = pdfDoc.addPage([PAGE_W, PAGE_H]);

  pages.push(page);

  // ─── 4) HEADER ──────────────────────────────────────────────────────────────

  let y = PAGE_H - ROW_H * 3;

  // Title

  const title = 'Loading List';

  const tW    = globalFontB.widthOfTextAtSize(title, 16);

  drawText(page, title, (PAGE_W - tW) / 2, y, 16, globalFontB);

  // Company & Creation date

  y -= ROW_H + 2;

  drawText(page, 'ASML Netherlands B.V.', LEFT, y, 10, globalFontB);

  drawText(page, `Creation date: ${formatDT(new Date())}`, PAGE_W - LEFT - 150, y, 10);

  // Logistics service provider (start at page center)

  y -= ROW_H;

  const CX = PAGE_W / 2;

  const maxHeaderWidth = PAGE_W - CX - LEFT;

  drawEllipsizedText(

    page,

    `Logistics service provider: ${data.provider}`,

    CX, y,

    maxHeaderWidth,

    10,

    globalFont

  );

  // Service line: common root + slash-join suffixes

  y -= ROW_H;

  let svcText = svcArr[0] || '';

  if (svcArr.length > 1) {

    const first = svcArr[0];

    const cut   = first.lastIndexOf(' ');

    const root  = cut < 0 ? first : first.slice(0, cut);

    const suffixes = svcArr.map(s =>

      s.startsWith(root + ' ') ? s.slice(root.length + 1) : s

    );

    svcText = `${root} ${suffixes.join('/')}`;

  }

  drawEllipsizedText(

    page,

    `Service: ${svcText}`,

    CX, y,

    maxHeaderWidth,

    10,

    globalFont

  );

  // Transport start, licence plate, remarks


  y -= ROW_H;

  drawText(page, 'Licence plate:', LEFT, y, 10, globalFont);

  y -= ROW_H;

  drawText(page, 'Remarks:', LEFT, y, 10, globalFont);

  // Totals line

  y -= ROW_H + GAP_AFTER_TOTAL;

  drawText(page, `Amount of orders: ${data.orders}`, LEFT, y, 8);

  drawText(page, `Total weight: ${data.weight.toFixed(2)} kg`, LEFT + 200, y, 8);

  drawText(page, `Total volume: ${data.volume.toFixed(3)} m³`, LEFT + 360, y, 8);

  drawText(page, `Amount of HUs: ${data.huCount}`, LEFT + 520, y, 8);

  // ─── 5) TABLE HEADER ─────────────────────────────────────────────────────────

  y -= ROW_H * 0.55 + HEADER_H;

  fillRect(page, LEFT, y + HEADER_H, TABLE_W, HEADER_H, PDFLib.rgb(0.9, 0.9, 0.9));

  let x = LEFT;

  COL_HEADERS.forEach(([h1, h2], i) => {

    drawText(page, h1, x + 2, y + ROW_H * 1.2, 8, globalFontB);

    if (h2) drawText(page, h2, x + 2, y + ROW_H * 0.2, 8, globalFontB);

    x += COL_WIDTHS[i];

  });

  drawLine(page, LEFT, y, LEFT + TABLE_W, y);

  y -= ROW_H * 1.25;

  // ─── 6) TABLE ROWS & PAGINATION ─────────────────────────────────────────────

  let pageNum = 1;

  for (const row of data.rows) {

    if (y < ROW_H * 4) {

      page = pdfDoc.addPage([PAGE_W, PAGE_H]);

      pages.push(page);

      pageNum++;

      y = PAGE_H - ROW_H * 4;

      // repeat header row

      fillRect(page, LEFT, y + HEADER_H, TABLE_W, HEADER_H, PDFLib.rgb(0.9, 0.9, 0.9));

      x = LEFT;

      COL_HEADERS.forEach(([h1, h2], i) => {

        drawText(page, h1, x + 2, y + ROW_H * 1.2, 8, globalFontB);

        if (h2) drawText(page, h2, x + 2, y + ROW_H * 0.2, 8, globalFontB);

        x += COL_WIDTHS[i];

      });

      drawLine(page, LEFT, y, LEFT + TABLE_W, y);

      y -= ROW_H * 1.25;

    }

    // draw each cell with truncation

    x = LEFT;

    row.forEach((cell, i) => {

      drawCellText(page, cell, x + 2, y, COL_WIDTHS[i]);

      x += COL_WIDTHS[i];

    });

    drawLine(page, LEFT, y - 4, LEFT + TABLE_W, y - 4);

    y -= ROW_H;

  }

  // ─── 7) FOOTER ───────────────────────────────────────────────────────────────

  pages.forEach((pg, idx) =>

    drawFooter(pg, idx + 1, idx + 1 === pages.length, pages.length)

  );

  // ─── 8) SAVE & DOWNLOAD ─────────────────────────────────────────────────────

  const pdfBytes = await pdfDoc.save();

  const blob     = new Blob([pdfBytes], { type: 'application/pdf' });

  const a        = document.createElement('a');

  a.href         = URL.createObjectURL(blob);

  a.download     = 'Merged_Manifest.pdf';

  a.click();

}
 

    document.getElementById('generateBtn').addEventListener('click', generatePDF);
</script>
<script>
VANTA.GLOBE({
 el: "#vanta-bg",
 mouseControls: true,
 touchControls: true,
 gyroControls: false,
 minHeight: 300.00,
 minWidth: 300.00,
 scale: 1.00,
 scaleMobile: 1.00,
 color: 0xD40511,        // DHL red
 backgroundColor: 0xf7f9fc // 
});
</script>

</body>
</html>
 
